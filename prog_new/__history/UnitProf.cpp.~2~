//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UnitProf.h"
#include "UnitAutor.h" // Для доступу до FormAutor->AuthenticatedUserID
#include <Vcl.Dialogs.hpp>
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TFormProf *FormProf;
//---------------------------------------------------------------------------
__fastcall TFormProf::TFormProf(TComponent* Owner)
	: TForm(Owner)
{
	FUserID = -1;
}
//---------------------------------------------------------------------------
void __fastcall TFormProf::SetUserID(int UserID)
{
	FUserID = UserID;
}
void __fastcall TFormProf::LoadUserProfile()
{
	if (FUserID == -1) {
		ShowMessage("Помилка: ID користувача не встановлено. Неможливо завантажити профіль.");
		return;
	}

	try {
		if (ADOQueryProf->Active) {
			ADOQueryProf->Close();
		}
		ADOQueryProf->SQL->Clear();


		ADOQueryProf->SQL->Add("SELECT U.ПІП, U.Статус, COUNT(P.КодДоговору) AS КількістьДоговорів ");
		ADOQueryProf->SQL->Add("FROM [User] AS U ");
		ADOQueryProf->SQL->Add("LEFT JOIN [Policy] AS P ON U.КодКористувача = P.КодКористувача ");
		ADOQueryProf->SQL->Add("WHERE U.КодКористувача = :UserID ");
		ADOQueryProf->SQL->Add("GROUP BY U.ПІП, U.Статус");

		ADOQueryProf->Parameters->ParamByName("UserID")->Value = FUserID;
		ADOQueryProf->Open();

		if (!ADOQueryProf->Eof) {

			EditName->Text = ADOQueryProf->Fields->FieldByName("Ім_яКористувача")->AsString;
			EditStatus->Text = ADOQueryProf->Fields->FieldByName("Статус")->AsString;
			EditPolicyCount->Text = ADOQueryProf->Fields->FieldByName("КількістьДоговорів")->AsString;
		} else {
			ShowMessage("Дані про користувача з ID " + IntToStr(FUserID) + " не знайдено.");
			EditName->Text = "";
			EditStatus->Text = "";
			EditPolicyCount->Text = "0";
		}
	} catch (Exception &E) {
		ShowMessage("Помилка завантаження профілю користувача: " + E.Message);
	}
}
void __fastcall TFormProf::FormCreate(TObject *Sender)
{
    try
	{

		ADOConnectionProf->Connected = true;

        // Поля для відображення робимо тільки для читання
        EditName->ReadOnly = true;
        EditStatus->ReadOnly = true;
        EditPolicyCount->ReadOnly = true;
	}
	catch (Exception &E)
	{
		ShowMessage("Помилка підключення до БД для 'Профілю': " + E.Message + "\nПеревірте шлях до бази даних та налаштування ADOConnectionProf.");
		ModalResult = mrCancel; // Закрити форму, якщо підключення не вдалося
		return;
	}
}
//---------------------------------------------------------------------------
void __fastcall TFormProf::Button1Click(TObject *Sender)
{
	Close();
}
//---------------------------------------------------------------------------
void __fastcall TFormProf::FormClose(TObject *Sender, TCloseAction &Action)
{
	// Закриваємо ADOQuery та ADOConnection при закритті форми
	if (ADOQueryProf->Active) {
		ADOQueryProf->Close();
	}
	if (ADOConnectionProf->Connected) {
		ADOConnectionProf->Close();
	}
}
//---------------------------------------------------------------------------
void __fastcall TFormProf::FormShow(TObject *Sender)
{
	LoadUserProfile();
}
//---------------------------------------------------------------------------
